# FastAPI Backend API Server
# Standard Python runtime for containerized deployment
FROM python:3.11-slim

# Set working directory
WORKDIR /app

# Copy requirements file
COPY requirements.txt /app/

# Install Python dependencies
# Use --no-cache-dir to reduce image size
# Upgrade pip first for better dependency resolution
# Set CXX environment variable for soxr compilation
# Note: soxr==0.3.7 is pinned in requirements.txt for nanobind compatibility
ENV CXX=g++
RUN apt-get update && \
    apt-get install -y --no-install-recommends g++ && \
    pip install --upgrade pip && \
    pip install --no-cache-dir -r /app/requirements.txt && \
    pip install --no-cache-dir uvicorn[standard] && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Copy application code
COPY app/ /app/app/

# Expose API port
EXPOSE 8000

# Set environment variables
ENV PYTHONUNBUFFERED=1

# Run FastAPI application with uvicorn
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]

# Required environment variables (set via container runtime):
# - DATABASE_URL
# - SUPABASE_URL
# - SUPABASE_SERVICE_ROLE_KEY
# - SUPABASE_ANON_KEY
# - S3_BUCKET_NAME
# - AWS_REGION
# - SQS_QUEUE_URL
# - REPLICATE_API_TOKEN
# - OPENAI_API_KEY
# - AWS_ACCESS_KEY_ID
# - AWS_SECRET_ACCESS_KEY

# Labels for documentation
LABEL maintainer="AI Ad Video Generator"
LABEL description="FastAPI Backend API Server"
LABEL version="1.0.0"

