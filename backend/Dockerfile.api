# AWS Lambda Docker image for FastAPI backend API
# Based on official AWS Lambda Python runtime
FROM public.ecr.aws/lambda/python:3.11

# Copy requirements file
COPY requirements.txt ${LAMBDA_TASK_ROOT}/

# Install Python dependencies including mangum for Lambda integration
# Use --no-cache-dir to reduce image size
# Upgrade pip first for better dependency resolution
RUN pip install --upgrade pip && \
    pip install --no-cache-dir -r ${LAMBDA_TASK_ROOT}/requirements.txt && \
    pip install --no-cache-dir mangum

# Copy application code
COPY app/ ${LAMBDA_TASK_ROOT}/app/

# Copy API Lambda handler
COPY api_handler.py ${LAMBDA_TASK_ROOT}/

# Set Lambda handler
# Format: filename.function_name
CMD ["api_handler.handler"]

# Environment variables will be set in Lambda function configuration
# Required env vars:
# - DATABASE_URL
# - SUPABASE_URL
# - SUPABASE_SERVICE_ROLE_KEY
# - SUPABASE_ANON_KEY
# - S3_BUCKET_NAME
# - AWS_REGION
# - SQS_QUEUE_URL
# - REPLICATE_API_TOKEN
# - OPENAI_API_KEY

# Lambda runtime will provide:
# - AWS_ACCESS_KEY_ID
# - AWS_SECRET_ACCESS_KEY
# - AWS_SESSION_TOKEN
# - AWS_REGION (also set by us for consistency)

# Labels for documentation
LABEL maintainer="AI Ad Video Generator"
LABEL description="AWS Lambda API for FastAPI backend via Function URL"
LABEL version="1.0.0"

